<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cricscanner Admin</title>
    <link rel="stylesheet" href="../public/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['\"Inter\"', 'system-ui', 'sans-serif'],
            },
            boxShadow: {
              glow: '0 0 40px -10px rgba(34, 211, 238, 0.45)',
            },
          },
        },
      };
    </script>
    <script>
      (function enforcePrivateAccess() {
        const REQUIRED_KEY = 'RAMAN2025';
        const params = new URLSearchParams(window.location.search);
        if (params.get('key') !== REQUIRED_KEY) {
          alert('Access Denied');
          window.location.href = '../public/index.html';
          return;
        }

        const pass = prompt('Enter admin password');
        if (pass !== 'Raman@AIsecure') {
          alert('Access Denied');
          window.location.href = '../public/index.html';
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js" defer></script>
    <script src="../public/js/storage.js" defer></script>
  </head>
  <body class="bg-gradient-to-br from-slate-950 via-slate-950 to-blue-950 text-slate-100 min-h-screen">
    <header class="border-b border-slate-800/60 bg-slate-950/70 backdrop-blur">
      <div class="mx-auto flex max-w-6xl flex-col gap-4 px-6 py-10 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.35em] text-emerald-200/80">Cricscanner Control Room</p>
          <h1 class="mt-2 text-4xl font-bold text-white">Admin Dashboard</h1>
          <p class="mt-3 max-w-2xl text-sm text-slate-300">
            Manage tournaments and matches. All times are stored and interpreted in Eastern Time (ET). Updates reflect instantly across the public dashboard.
          </p>
        </div>
        <a href="../public/index.html" class="text-sm font-semibold text-emerald-300 transition hover:text-emerald-200">← Back to dashboard</a>
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-6 py-12">
      <div class="grid gap-12 lg:grid-cols-[2fr,3fr]">
        <section class="space-y-8">
          <article class="rounded-3xl border border-slate-800/60 bg-slate-900/70 p-8 shadow-lg shadow-blue-900/20">
            <h2 class="text-2xl font-semibold text-white">Tournaments</h2>
            <p class="mt-2 text-sm text-slate-400">Create and update tournaments. Deleting a tournament will remove its matches.</p>

            <form id="tournamentForm" class="mt-6 space-y-5">
              <input type="hidden" id="tournamentId" />
              <div>
                <label for="tournamentName" class="text-xs uppercase tracking-[0.35em] text-slate-400">Tournament name</label>
                <input
                  id="tournamentName"
                  type="text"
                  required
                  class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                  placeholder="World Cup"
                />
              </div>
              <div>
                <label for="tournamentLocation" class="text-xs uppercase tracking-[0.35em] text-slate-400">Primary location</label>
                <input
                  id="tournamentLocation"
                  type="text"
                  class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                  placeholder="Global"
                />
              </div>
              <div>
                <label for="tournamentDescription" class="text-xs uppercase tracking-[0.35em] text-slate-400">Description</label>
                <textarea
                  id="tournamentDescription"
                  rows="3"
                  class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                  placeholder="Short note about the tournament"
                ></textarea>
              </div>
              <div class="flex items-center justify-between gap-4">
                <button
                  type="submit"
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-sky-500 to-emerald-400 px-6 py-3 text-sm font-semibold text-slate-950 shadow-glow transition hover:brightness-110"
                >
                  <span id="tournamentSubmitLabel">Save tournament</span>
                </button>
                <button
                  type="button"
                  id="cancelTournamentEdit"
                  class="hidden rounded-full border border-slate-700/70 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-slate-400 transition hover:border-slate-500 hover:text-slate-200"
                >
                  Cancel edit
                </button>
              </div>
            </form>

            <div id="tournamentList" class="mt-8 space-y-4"></div>
          </article>

          <article class="rounded-3xl border border-slate-800/60 bg-slate-900/70 p-8 shadow-lg shadow-blue-900/20">
            <div class="flex items-center justify-between gap-4">
              <h2 class="text-2xl font-semibold text-white">Matches</h2>
              <button
                type="button"
                id="autoAddMatches"
                class="rounded-full border border-emerald-400/50 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200 transition hover:border-emerald-400 hover:text-emerald-100"
              >
                Auto-add Matches (AI)
              </button>
            </div>
            <p class="mt-2 text-sm text-slate-400">Schedule fixtures with ET start and (optional) end times. Scores can be added once completed.</p>

            <form id="matchForm" class="mt-6 space-y-5">
              <input type="hidden" id="matchId" />
              <div>
                <label for="matchTournament" class="text-xs uppercase tracking-[0.35em] text-slate-400">Tournament</label>
                <select
                  id="matchTournament"
                  required
                  class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                ></select>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="teamA" class="text-xs uppercase tracking-[0.35em] text-slate-400">Team A</label>
                  <input
                    id="teamA"
                    type="text"
                    required
                    class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                    placeholder="Team A"
                  />
                </div>
                <div>
                  <label for="teamB" class="text-xs uppercase tracking-[0.35em] text-slate-400">Team B</label>
                  <input
                    id="teamB"
                    type="text"
                    required
                    class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                    placeholder="Team B"
                  />
                </div>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="startTime" class="text-xs uppercase tracking-[0.35em] text-slate-400">Start time (ET)</label>
                  <input
                    id="startTime"
                    type="datetime-local"
                    required
                    class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                  />
                </div>
                <div>
                  <label for="endTime" class="text-xs uppercase tracking-[0.35em] text-slate-400">End time (ET)</label>
                  <input
                    id="endTime"
                    type="datetime-local"
                    class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                  />
                </div>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="scoreA" class="text-xs uppercase tracking-[0.35em] text-slate-400">Score A</label>
                  <input
                    id="scoreA"
                    type="text"
                    class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                    placeholder="210/4"
                  />
                </div>
                <div>
                  <label for="scoreB" class="text-xs uppercase tracking-[0.35em] text-slate-400">Score B</label>
                  <input
                    id="scoreB"
                    type="text"
                    class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                    placeholder="208/9"
                  />
                </div>
              </div>
              <div>
                <label for="matchLocation" class="text-xs uppercase tracking-[0.35em] text-slate-400">Venue</label>
                <input
                  id="matchLocation"
                  type="text"
                  class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none transition focus:border-emerald-400/60 focus:ring-2 focus:ring-emerald-400/40"
                  placeholder="Stadium"
                />
              </div>
              <div class="flex items-center justify-between gap-4">
                <button
                  type="submit"
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-sky-500 to-emerald-400 px-6 py-3 text-sm font-semibold text-slate-950 shadow-glow transition hover:brightness-110"
                >
                  <span id="matchSubmitLabel">Save match</span>
                </button>
                <button
                  type="button"
                  id="cancelMatchEdit"
                  class="hidden rounded-full border border-slate-700/70 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-slate-400 transition hover:border-slate-500 hover:text-slate-200"
                >
                  Cancel edit
                </button>
              </div>
            </form>
            <div id="matchList" class="mt-8 space-y-4"></div>
          </article>
        </section>

        <section class="space-y-8">
          <article class="rounded-3xl border border-slate-800/60 bg-slate-900/70 p-8 shadow-lg shadow-blue-900/20">
            <div class="flex items-center justify-between gap-4">
              <h2 class="text-2xl font-semibold text-white">All Tournaments</h2>
              <button
                type="button"
                id="resetData"
                class="rounded-full border border-red-400/40 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-red-300 transition hover:border-red-400 hover:text-red-200"
              >
                Reset to defaults
              </button>
            </div>
            <div id="tournamentsOverview" class="mt-6 space-y-4"></div>
          </article>

          <article class="rounded-3xl border border-slate-800/60 bg-slate-900/70 p-8 shadow-lg shadow-blue-900/20">
            <h2 class="text-2xl font-semibold text-white">Matches Overview</h2>
            <p class="mt-2 text-sm text-slate-400">Matches automatically appear in the correct bucket based on the current Eastern Time.</p>
            <div id="matchesOverview" class="mt-6 space-y-4"></div>
          </article>
        </section>
      </div>
    </main>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const { DateTime } = luxon;

      const tournamentForm = document.getElementById('tournamentForm');
      const tournamentId = document.getElementById('tournamentId');
      const tournamentName = document.getElementById('tournamentName');
      const tournamentLocation = document.getElementById('tournamentLocation');
      const tournamentDescription = document.getElementById('tournamentDescription');
      const tournamentList = document.getElementById('tournamentList');
      const tournamentSubmitLabel = document.getElementById('tournamentSubmitLabel');
      const cancelTournamentEdit = document.getElementById('cancelTournamentEdit');

      const matchForm = document.getElementById('matchForm');
      const matchId = document.getElementById('matchId');
      const matchTournament = document.getElementById('matchTournament');
      const teamA = document.getElementById('teamA');
      const teamB = document.getElementById('teamB');
      const startTime = document.getElementById('startTime');
      const endTime = document.getElementById('endTime');
      const scoreA = document.getElementById('scoreA');
      const scoreB = document.getElementById('scoreB');
      const matchLocation = document.getElementById('matchLocation');
      const matchSubmitLabel = document.getElementById('matchSubmitLabel');
      const cancelMatchEdit = document.getElementById('cancelMatchEdit');
      const matchList = document.getElementById('matchList');

      const tournamentsOverview = document.getElementById('tournamentsOverview');
      const matchesOverview = document.getElementById('matchesOverview');
      const resetData = document.getElementById('resetData');
      const autoAddMatches = document.getElementById('autoAddMatches');

      let state = { tournaments: [], matches: [] };

      async function refreshState() {
        state = await window.CricStorage.getData();
        return state;
      }

      function formatInput(datetime) {
        if (!datetime) return '';
        const dt = DateTime.fromISO(datetime, { zone: 'America/New_York' });
        return dt.isValid ? dt.toFormat("yyyy-LL-dd'T'HH:mm") : '';
      }

      function resolveStatus(match, now) {
        const start = DateTime.fromISO(match.startTime, { zone: 'America/New_York' });
        if (!start.isValid) return 'upcoming';
        const end = match.endTime ? DateTime.fromISO(match.endTime, { zone: 'America/New_York' }) : null;
        if (now < start) return 'upcoming';
        if (end && now > end) return 'completed';
        if (!end) {
          const assumed = start.plus({ hours: 4 });
          if (now > assumed) return 'completed';
        }
        return 'live';
      }

      function formatDisplay(datetime) {
        if (!datetime) return '—';
        const dt = DateTime.fromISO(datetime, { zone: 'America/New_York' });
        return dt.isValid ? dt.toFormat("ccc, LLL dd • hh:mm a 'ET'") : '—';
      }

      function populateTournamentSelect() {
        const { tournaments } = state;
        matchTournament.innerHTML = '';
        tournaments.forEach((tournament) => {
          const option = document.createElement('option');
          option.value = tournament.id;
          option.textContent = tournament.name;
          matchTournament.appendChild(option);
        });
        if (!tournaments.length) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Create a tournament first';
          matchTournament.appendChild(option);
        }
      }

      function renderTournamentList() {
        const { tournaments } = state;
        tournamentList.innerHTML = '';
        if (!tournaments.length) {
          tournamentList.innerHTML = '<p class="text-sm text-slate-400">No tournaments yet.</p>';
          return;
        }
        tournaments.forEach((tournament) => {
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-slate-800/60 bg-slate-950/60 p-5';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div>
                <h3 class="text-lg font-semibold text-white">${tournament.name}</h3>
                <p class="mt-1 text-xs uppercase tracking-[0.35em] text-slate-500">${tournament.location || 'Location TBA'}</p>
                ${tournament.description ? `<p class="mt-3 text-sm text-slate-300">${tournament.description}</p>` : ''}
              </div>
              <div class="flex gap-2">
                <button data-action="edit" data-id="${tournament.id}" class="rounded-full border border-sky-400/50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-sky-200 transition hover:border-sky-400 hover:text-white">Edit</button>
                <button data-action="delete" data-id="${tournament.id}" class="rounded-full border border-red-400/50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-red-300 transition hover:border-red-400 hover:text-red-200">Delete</button>
              </div>
            </div>
          `;
          tournamentList.appendChild(card);
        });
      }

      function renderTournamentsOverview() {
        const { tournaments, matches } = state;
        tournamentsOverview.innerHTML = '';
        if (!tournaments.length) {
          tournamentsOverview.innerHTML = '<p class="text-sm text-slate-400">No tournaments available.</p>';
          return;
        }
        tournaments.forEach((tournament) => {
          const tiedMatches = matches.filter((match) => match.tournamentId === tournament.id);
          const teams = new Set();
          tiedMatches.forEach((match) => {
            teams.add(match.teamA);
            teams.add(match.teamB);
          });
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-slate-800/60 bg-slate-950/60 p-5';
          card.innerHTML = `
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h3 class="text-lg font-semibold text-white">${tournament.name}</h3>
                <p class="text-sm text-slate-400">${tournament.location || 'Global venues'}</p>
              </div>
              <span class="rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200">${tiedMatches.length} matches</span>
            </div>
            <p class="mt-3 text-xs uppercase tracking-[0.35em] text-slate-500">Teams</p>
            <p class="mt-1 text-sm text-slate-300">${teams.size ? Array.from(teams).join(', ') : 'Teams TBA'}</p>
          `;
          tournamentsOverview.appendChild(card);
        });
      }

      function renderMatchesOverview() {
        const { matches, tournaments } = state;
        matchesOverview.innerHTML = '';
        if (!matches.length) {
          matchesOverview.innerHTML = '<p class="text-sm text-slate-400">No matches scheduled yet.</p>';
          return;
        }
        const now = DateTime.now().setZone('America/New_York');
        const tournamentsById = Object.fromEntries(tournaments.map((t) => [t.id, t]));
        matches
          .slice()
          .sort((a, b) => DateTime.fromISO(a.startTime) - DateTime.fromISO(b.startTime))
          .forEach((match) => {
            const status = resolveStatus(match, now);
            const tournament = tournamentsById[match.tournamentId];
            const badgeClasses =
              status === 'live'
                ? 'border-emerald-400/40 bg-emerald-400/15 text-emerald-200'
                : status === 'completed'
                ? 'border-sky-400/40 bg-sky-400/10 text-sky-200'
                : 'border-slate-500/40 bg-slate-500/10 text-slate-300';
            const card = document.createElement('div');
            card.className = 'rounded-2xl border border-slate-800/60 bg-slate-950/60 p-5';
            card.innerHTML = `
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <p class="text-xs uppercase tracking-[0.35em] text-slate-500">${tournament ? tournament.name : 'Untitled Tournament'}</p>
                  <h3 class="mt-2 text-lg font-semibold text-white">${match.teamA} <span class="text-slate-500">vs</span> ${match.teamB}</h3>
                  <p class="mt-2 text-sm text-slate-300">${formatDisplay(match.startTime)}${
              match.endTime ? ` → ${formatDisplay(match.endTime)}` : ''
            }</p>
                </div>
                <span class="rounded-full border ${badgeClasses} px-3 py-1 text-xs font-semibold uppercase tracking-[0.35em]">${status}</span>
              </div>
            `;
            matchesOverview.appendChild(card);
          });
      }

      function resetTournamentForm() {
        tournamentId.value = '';
        tournamentName.value = '';
        tournamentLocation.value = '';
        tournamentDescription.value = '';
        tournamentSubmitLabel.textContent = 'Save tournament';
        cancelTournamentEdit.classList.add('hidden');
      }

      function resetMatchForm() {
        matchId.value = '';
        teamA.value = '';
        teamB.value = '';
        startTime.value = '';
        endTime.value = '';
        scoreA.value = '';
        scoreB.value = '';
        matchLocation.value = '';
        matchSubmitLabel.textContent = 'Save match';
        cancelMatchEdit.classList.add('hidden');
        populateTournamentSelect();
      }

      tournamentForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
          id: tournamentId.value || window.CricStorage.generateId('tour'),
          name: tournamentName.value.trim(),
          location: tournamentLocation.value.trim(),
          description: tournamentDescription.value.trim(),
        };
        state = await window.CricStorage.upsertTournament(payload);
        resetTournamentForm();
        renderAllFromState();
      });

      tournamentList.addEventListener('click', async (event) => {
        const action = event.target.dataset.action;
        if (!action) return;
        const id = event.target.dataset.id;
        if (action === 'edit') {
          const { tournaments } = state;
          const tournament = tournaments.find((t) => t.id === id);
          if (!tournament) return;
          tournamentId.value = tournament.id;
          tournamentName.value = tournament.name;
          tournamentLocation.value = tournament.location || '';
          tournamentDescription.value = tournament.description || '';
          tournamentSubmitLabel.textContent = 'Update tournament';
          cancelTournamentEdit.classList.remove('hidden');
          tournamentName.focus();
        } else if (action === 'delete') {
          if (confirm('Delete this tournament and its matches?')) {
            state = await window.CricStorage.deleteTournament(id);
            resetTournamentForm();
            renderAllFromState();
          }
        }
      });

      cancelTournamentEdit.addEventListener('click', () => {
        resetTournamentForm();
      });

      matchForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!matchTournament.value) {
          alert('Please create a tournament first.');
          return;
        }
        const start = DateTime.fromFormat(startTime.value, "yyyy-LL-dd'T'HH:mm", { zone: 'America/New_York' });
        const end = endTime.value
          ? DateTime.fromFormat(endTime.value, "yyyy-LL-dd'T'HH:mm", { zone: 'America/New_York' })
          : null;
        const payload = {
          id: matchId.value || window.CricStorage.generateId('match'),
          tournamentId: matchTournament.value,
          teamA: teamA.value.trim(),
          teamB: teamB.value.trim(),
          startTime: start.isValid ? start.toISO() : startTime.value,
          endTime: end && end.isValid ? end.toISO() : '',
          scoreA: scoreA.value.trim(),
          scoreB: scoreB.value.trim(),
          location: matchLocation.value.trim(),
        };
        state = await window.CricStorage.upsertMatch(payload);
        resetMatchForm();
        renderAllFromState();
      });

      cancelMatchEdit.addEventListener('click', () => {
        resetMatchForm();
      });
      function renderMatchList() {
        const { matches, tournaments } = state;
        matchList.innerHTML = '';
        if (!matches.length) {
          matchList.innerHTML = '<p class="text-sm text-slate-400">No matches scheduled yet.</p>';
          return;
        }
        const now = DateTime.now().setZone('America/New_York');
        const tournamentsById = Object.fromEntries(tournaments.map((t) => [t.id, t]));
        matches
          .slice()
          .sort((a, b) => DateTime.fromISO(a.startTime) - DateTime.fromISO(b.startTime))
          .forEach((match) => {
            const status = resolveStatus(match, now);
            const card = document.createElement('div');
            card.className = 'rounded-2xl border border-slate-800/60 bg-slate-950/60 p-5';
            card.innerHTML = `
              <div class="flex flex-wrap items-start justify-between gap-4">
                <div>
                  <p class="text-xs uppercase tracking-[0.35em] text-slate-500">${
                    tournamentsById[match.tournamentId]?.name || 'Untitled Tournament'
                  }</p>
                  <h3 class="mt-2 text-lg font-semibold text-white">${match.teamA} <span class="text-slate-500">vs</span> ${match.teamB}</h3>
                  <p class="mt-2 text-sm text-slate-300">${formatDisplay(match.startTime)}${
              match.endTime ? ` → ${formatDisplay(match.endTime)}` : ''
            }</p>
                </div>
                <div class="flex gap-2">
                  <button data-match-edit="${match.id}" class="rounded-full border border-sky-400/50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-sky-200 transition hover:border-sky-400 hover:text-white">Edit</button>
                  <button data-match-delete="${match.id}" class="rounded-full border border-red-400/50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-red-300 transition hover:border-red-400 hover:text-red-200">Delete</button>
                </div>
              </div>
              <p class="mt-3 text-xs uppercase tracking-[0.35em] text-slate-500">Status: ${status}</p>
            `;
            matchList.appendChild(card);
          });
      }

      document.addEventListener('click', async (event) => {
        const editId = event.target.dataset.matchEdit;
        const deleteId = event.target.dataset.matchDelete;
        if (editId) {
          const { matches } = state;
          const match = matches.find((m) => m.id === editId);
          if (!match) return;
          matchId.value = match.id;
          populateTournamentSelect();
          matchTournament.value = match.tournamentId;
          teamA.value = match.teamA;
          teamB.value = match.teamB;
          startTime.value = formatInput(match.startTime);
          endTime.value = formatInput(match.endTime);
          scoreA.value = match.scoreA || '';
          scoreB.value = match.scoreB || '';
          matchLocation.value = match.location || '';
          matchSubmitLabel.textContent = 'Update match';
          cancelMatchEdit.classList.remove('hidden');
          teamA.focus();
        }
        if (deleteId) {
          if (confirm('Delete this match?')) {
            state = await window.CricStorage.deleteMatch(deleteId);
            resetMatchForm();
            renderAllFromState();
          }
        }
      });

      resetData.addEventListener('click', async () => {
        if (confirm('Reset tournaments and matches to the default data set?')) {
          state = await window.CricStorage.resetToDefaults();
          resetTournamentForm();
          resetMatchForm();
          renderAllFromState();
        }
      });

      function simulateAIDataset() {
        const now = DateTime.now().setZone('America/New_York');
        const adjectives = ['Quantum', 'Aurora', 'Velocity', 'Frontier', 'Summit', 'Legends', 'Prime'];
        const nouns = ['Showdown', 'Championship', 'Series', 'Clash', 'Cup', 'Carnival', 'Masters'];
        const locations = [
          'New York, USA',
          'Toronto, Canada',
          'London, UK',
          'Barbados',
          'Sydney, Australia',
          'Mumbai, India',
          'Cape Town, South Africa',
        ];
        const venues = [
          'Prospect Park Oval',
          'Eden Gardens Annex',
          'Harbor Lights Stadium',
          'Sunset Arena',
          'Skyline Dome',
          'Lakeside Grounds',
          'Aurora Cricket Centre',
        ];
        const teamPool = [
          'Brooklyn Blazers',
          'Harlem Hawks',
          'Queens Quantum',
          'Bronx Bolts',
          'Manhattan Meteors',
          'Jersey Juggernauts',
          'Staten Strikers',
          'Hudson Hurricanes',
          'Liberty Lightning',
        ];

        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const pick = (arr) => arr[randomInt(0, arr.length - 1)];
        const uniqueTournamentKey = `ai-tour-${Date.now()}`;
        const tournament = {
          key: uniqueTournamentKey,
          name: `${pick(adjectives)} ${pick(nouns)}`,
          location: pick(locations),
          description: 'Auto-generated fixtures prepared by the Cricscanner assistant.',
        };

        const matches = [];
        const matchCount = randomInt(3, 6);
        for (let index = 0; index < matchCount; index += 1) {
          let teamA = pick(teamPool);
          let teamB = pick(teamPool);
          while (teamB === teamA) {
            teamB = pick(teamPool);
          }

          const scenario = pick(['upcoming', 'live', 'completed']);
          let startTime = now.plus({ days: randomInt(1, 10), hours: randomInt(0, 12) });
          let endTime = '';
          let scoreA = '';
          let scoreB = '';

          if (scenario === 'completed') {
            const start = now.minus({ days: randomInt(1, 6), hours: randomInt(0, 5) });
            const durationHours = randomInt(3, 6);
            startTime = start;
            endTime = start.plus({ hours: durationHours }).toISO();
            const baseScore = randomInt(120, 210);
            scoreA = `${baseScore}/${randomInt(3, 8)}`;
            scoreB = `${baseScore - randomInt(-10, 25)}/${randomInt(3, 9)}`;
          } else if (scenario === 'live') {
            const start = now.minus({ hours: randomInt(0, 2), minutes: randomInt(15, 55) });
            startTime = start;
            endTime = now.plus({ hours: 2 }).toISO();
            scoreA = `${randomInt(60, 120)}/${randomInt(0, 4)}`;
            scoreB = `${randomInt(40, 110)}/${randomInt(0, 4)}`;
          }

          matches.push({
            tournamentKey: uniqueTournamentKey,
            teamA,
            teamB,
            startTime: startTime.toISO(),
            endTime,
            location: `${pick(venues)}, ${tournament.location}`,
            scoreA,
            scoreB,
          });
        }

        return { tournaments: [tournament], matches };
      }

      function normalizeAssistantPayload(payload) {
        if (!payload) return null;
        if (!Array.isArray(payload.tournaments) || !Array.isArray(payload.matches)) {
          return null;
        }
        const tournaments = payload.tournaments.map((item, index) => ({
          key: item.id || item.key || `remote-tour-${index}`,
          name: item.name || item.title || `Imported Tournament ${index + 1}`,
          location: item.location || item.venue || '',
          description: item.description || item.summary || '',
        }));
        if (!tournaments.length) {
          return null;
        }
        const firstKey = tournaments[0].key;
        const matches = payload.matches.map((item, index) => ({
          tournamentKey:
            item.tournamentId ||
            item.tournamentKey ||
            (typeof item.tournament === 'string' ? item.tournament : firstKey) ||
            firstKey,
          teamA: item.teamA || item.home || `Team ${index + 1}A`,
          teamB: item.teamB || item.away || `Team ${index + 1}B`,
          startTime:
            item.startTime ||
            item.scheduledAt ||
            DateTime.now().plus({ days: index + 1 }).setZone('America/New_York').toISO(),
          endTime: item.endTime || item.endsAt || '',
          location: item.location || item.venue || '',
          scoreA: item.scoreA || '',
          scoreB: item.scoreB || '',
        }));
        if (!matches.length) {
          return null;
        }
        return { tournaments, matches };
      }

      async function requestAssistantDataset() {
        const simulated = simulateAIDataset();
        try {
          const response = await fetch('https://example.com/api/matches', { cache: 'no-store' });
          if (response.ok) {
            const parsed = await response.json().catch(() => null);
            const normalized = normalizeAssistantPayload(parsed);
            if (normalized) {
              return normalized;
            }
          }
        } catch (error) {
          console.info('Dummy API unreachable, using simulated dataset.', error);
        }
        return simulated;
      }

      if (autoAddMatches) {
        autoAddMatches.addEventListener('click', async () => {
          const originalLabel = autoAddMatches.textContent;
          autoAddMatches.disabled = true;
          autoAddMatches.textContent = 'Auto-populating…';
          try {
            const dataset = await requestAssistantDataset();
            const tournamentMap = new Map();
            const createdMatches = [];

            for (const entry of dataset.tournaments) {
              const existing = state.tournaments.find(
                (tournament) => tournament.name.toLowerCase() === entry.name.toLowerCase()
              );
              const id = existing ? existing.id : window.CricStorage.generateId('tour');
              const payload = {
                id,
                name: entry.name,
                location: entry.location || '',
                description: entry.description || '',
              };
              state = await window.CricStorage.upsertTournament(payload);
              tournamentMap.set(entry.key, payload.id);
            }

            for (const matchEntry of dataset.matches) {
              const tournamentId = tournamentMap.get(matchEntry.tournamentKey) || state.tournaments[0]?.id;
              if (!tournamentId) continue;
              const payload = {
                id: window.CricStorage.generateId('match'),
                tournamentId,
                teamA: matchEntry.teamA,
                teamB: matchEntry.teamB,
                startTime: matchEntry.startTime,
                endTime: matchEntry.endTime || '',
                scoreA: matchEntry.scoreA || '',
                scoreB: matchEntry.scoreB || '',
                location: matchEntry.location || '',
              };
              state = await window.CricStorage.upsertMatch(payload);
              createdMatches.push({ ...payload });
            }

            renderAllFromState();

            if (dataset.tournaments.length) {
              const firstKey = dataset.tournaments[0].key;
              const assignedId = tournamentMap.get(firstKey);
              if (assignedId) {
                const tournament = state.tournaments.find((item) => item.id === assignedId);
                if (tournament) {
                  tournamentId.value = tournament.id;
                  tournamentName.value = tournament.name;
                  tournamentLocation.value = tournament.location || '';
                  tournamentDescription.value = tournament.description || '';
                  tournamentSubmitLabel.textContent = 'Update tournament';
                  cancelTournamentEdit.classList.remove('hidden');
                }
              }
            }

            if (createdMatches.length) {
              const match = createdMatches[0];
              populateTournamentSelect();
              matchId.value = match.id;
              matchTournament.value = match.tournamentId;
              teamA.value = match.teamA;
              teamB.value = match.teamB;
              startTime.value = formatInput(match.startTime);
              endTime.value = formatInput(match.endTime);
              scoreA.value = match.scoreA;
              scoreB.value = match.scoreB;
              matchLocation.value = match.location;
              matchSubmitLabel.textContent = 'Update match';
              cancelMatchEdit.classList.remove('hidden');
            }

            alert('Assistant populated new fixtures. Review and adjust before publishing.');
          } catch (error) {
            console.error('Auto-add failed', error);
            alert('Auto-add failed. Please try again later.');
          } finally {
            autoAddMatches.disabled = false;
            autoAddMatches.textContent = originalLabel;
          }
        });
      }

      function renderAllFromState() {
        populateTournamentSelect();
        renderTournamentList();
        renderMatchList();
        renderTournamentsOverview();
        renderMatchesOverview();
      }

      async function renderAll() {
        await refreshState();
        renderAllFromState();
      }

      window.addEventListener('storage', () => renderAll());

      renderAll();
      });
    </script>
  </body>
</html>
